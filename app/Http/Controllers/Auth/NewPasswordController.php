<?php

namespace App\Http\Controllers\Auth;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Password;
use Illuminate\Support\Facades\Hash;
use Illuminate\Validation\ValidationException;
use App\Models\User;

/**
 * ğŸ” NewPasswordController
 *
 * ĞšĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»Ğ»ĞµÑ€ Ğ´Ğ»Ñ ÑĞ±Ñ€Ğ¾ÑĞ° Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ Ğ¿Ğ¾ ÑÑÑ‹Ğ»ĞºĞµ Ğ¸Ğ· Ğ¿Ğ¸ÑÑŒĞ¼Ğ°
 *
 * ĞÑ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚ Ğ·Ğ°:
 * - ğŸ§¾ ĞŸĞ¾ĞºĞ°Ğ· Ñ„Ğ¾Ñ€Ğ¼Ñ‹ Ğ²Ğ²Ğ¾Ğ´Ğ° Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ
 * - âœ… ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºÑƒ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğ½Ğ° ÑĞ±Ñ€Ğ¾Ñ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ
 */
class NewPasswordController extends Controller
{
    /**
     * ğŸ§¾ create()
     *
     * ğŸ“„ ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµÑ‚ Ñ„Ğ¾Ñ€Ğ¼Ñƒ ÑĞ±Ñ€Ğ¾ÑĞ° Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ (Ñ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ¼)
     *
     * @param  \Illuminate\Http\Request  $request
     * @return \Illuminate\View\View
     */
    public function create(Request $request)
    {
        return view('auth.reset-password', [
            'request' => $request, // ĞŸĞµÑ€ĞµĞ´Ğ°Ñ‘Ğ¼ Ñ‚Ğ¾ĞºĞµĞ½ Ğ¸ email Ñ‡ĞµÑ€ĞµĞ· URL-Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹
        ]);
    }

    /**
     * ğŸ”„ store()
     *
     * âœ… ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ÑĞ±Ñ€Ğ¾Ñ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ:
     * - Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ñ‚Ğ¾ĞºĞµĞ½Ğ°, email Ğ¸ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ
     * - Ğ¡Ğ±Ñ€Ğ¾Ñ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ Ñ‡ĞµÑ€ĞµĞ· Ñ„Ğ°ÑĞ°Ğ´ Password
     * - Ğ¥ĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ
     *
     * @param  \Illuminate\Http\Request  $request
     * @return \Illuminate\Http\RedirectResponse
     */
    public function store(Request $request)
    {
        // ğŸ“Œ Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸Ğ· Ñ„Ğ¾Ñ€Ğ¼Ñ‹
        $request->validate([
            'token' => 'required',                        // Ğ¢Ğ¾ĞºĞµĞ½ Ğ¸Ğ· ÑÑÑ‹Ğ»ĞºĞ¸
            'email' => 'required|email',                  // Email Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
            'password' => 'required|min:8|confirmed',     // ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ + Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ
        ]);

        // ğŸ”§ ĞŸĞ¾Ğ¿Ñ‹Ñ‚ĞºĞ° ÑĞ±Ñ€Ğ¾ÑĞ° Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ Ñ‡ĞµÑ€ĞµĞ· Laravel Password Broker
        $status = Password::reset(
            $request->only('email', 'password', 'password_confirmation', 'token'),
            function (User $user, $password) {
                // ğŸ”‘ ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
                $user->password = Hash::make($password);
                $user->save();
            }
        );

        // ğŸ“¬ Ğ•ÑĞ»Ğ¸ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ â€” Ñ€ĞµĞ´Ğ¸Ñ€ĞµĞºÑ‚ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ Ğ²Ñ…Ğ¾Ğ´Ğ° Ñ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸ĞµĞ¼
        return $status === Password::PASSWORD_RESET
            ? redirect()->route('login')->with('status', __($status))
            : back()->withErrors(['email' => [__($status)]]);
    }
}
